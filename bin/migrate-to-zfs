#!/bin/zsh
set -exv

autoload -Uz zparseopts

self_given=$0
self=${0:t}

e() {
	echo -e "[$self_given]" "$@"
}

error() {
	local level="${level:-error}"
	e "$level:" "$@" >&2
}

death() {
	level=death error "$@"
	exit 1
}

usage() {
	echo "Usage: $self_given PATH [DATASET]"
}

zfs-exists zpool-exists() {
	${0%%-*} get -H name $1 #>/dev/null 2>&1
}

zfs-list zpool-list () {
    local cmd=(${(s:-:)0})

    local props=(name)
	zparseopts -DK p:=props

	$cmd -Ho "${(j:,:)props}" "$@"
}

zdataset-exists() {
	zfs get -H name $1 #>/dev/null 2>&1
}

zfs-get() {
	local dataset="$1"; shift
	zfs-list -d $dataset -- "$@"
}



find-path() {
    local path=$1:a
    local parts=(${(s:/:)path})

    local cur
    local -i idx=0
    for p in $#parts; do
        (( idx++ ))
        cur=${(j:/:)parts:1:$idx}
        zfs_mountpoint=$(zfs-get mountpoint)
}

ZPOOLS=($(zpool-list -p name))
: ${DEFAULT_ZPOOL:=${ZPOOLS:1}}

declare -A zd_to_mountpoint=(
    $(zfs-list -p name,mountpoint)
)

source_path=${1:A}; shift
requested_dest_dataset=$1
shift 2

if [[ -n $2 ]]; then
try_datasets=(
    ${2:-${source_path#/}}
)


tmp_dataset="${dataset}-${self}"
rename_path="${source_path}-original-${self}"

e "source_path=$source_path dataset=$dataset tmp_dataset=$tmp_dataset"

[[ $# -gt 0 ]] || usage
[[ -n "$source_path" && -n "$dataset" ]] || death "Bad arguments:" "source_path='$source_path' dataset='$dataset'"
[[ -d "$source_path" ]] || death "Given source_path='$source_path' is not a directory"

! zdataset-exists "$dataset" || death "Dataset already exists: $dataset"
! zdataset-exists "$tmp_dataset" || death "Dataset already exists: $tmp_dataset"

zfs create "$tmp_dataset"
mountpoint=$(zfs-get "$tmp_dataset" mountpoint)

mounted=$(zfs-get "$tmp_dataset" mounted)
[[ "$mounted" == "yes" ]] || death "Not mounted: tmp_dataset=$tmp_dataset"

rsync -avhPS "$source_path/" "$mountpoint"

mv -v "$source_path" "$rename_path"
zfs rename "$tmp_dataset" "$dataset" || death "Could not rename $tmp_dataset to $dataset"
rm -rf "$rename_path"

